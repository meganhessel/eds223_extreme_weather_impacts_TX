---
title: "texas_blackouts2"
format: html
editor: visual
---

# Texas Backouts 

## Downloading libraries and data

```{r}
# Import libraries 
#| message: false
#| warning: false
library(terra) # raster handling
library(tidyverse)
library(tmap) # map making
library(kableExtra) # table formatting
library(spData) # spatial data
library(spDataLarge) # spatial data
library(geodata) # spatial data
library(stars)
library(raster)
```


```{r}
#| output: FALSE

# Download Data 

# Night lights data (VNP46A1)
# with read_stars()... sf 
#light_1 <- read_stars(here::here("data", "VNP46A1", "VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
#light_2 <- read_stars(here::here("data", "VNP46A1", "VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
#light_3 <- read_stars(here::here("data", "VNP46A1", "VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
#light_4 <- read_stars(here::here("data", "VNP46A1", "VNP46A1.A2021047.h08v06.001.2021048091105.tif"))

# With rast()... terra
l1 <- rast("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif")
l2 <- rast("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif")
l3 <- rast("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif")
l4 <- rast("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif")


# Road Data 
roads <- st_read(here::here("data", "gis_osm_roads_free_1.gpkg"), query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'")

# House data 
houses <- st_read(
  here::here("data", "gis_osm_buildings_a_free_1.gpkg"),
  query = "
    SELECT *
    FROM gis_osm_buildings_a_free_1
    WHERE (type IS NULL AND name IS NULL)
       OR type IN ('residential', 'apartments', 'house', 'static_caravan', 'detached')
  ")

# Socioecomic Data... TEXAS 
soc_texas <- read_sf(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"))

# Texas geometries (polygons) 
# Looking at the various layeres 
st_layers(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"))
# Pulling out the geometry layer 
geom_texas <- vect("data/ACS_2019_5YR_TRACT_48_TEXAS.gdb", layer = "ACS_2019_5YR_TRACT_48_TEXAS")

# <- st_read(here::here("data/ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "ACS_2019_5YR_TRACT_48_TEXAS"))

```


## Coordinate Reference Systems

### Checking CRS

```{r}
#| output: False 

st_crs(l1) # WGS 84 
st_crs(l2) # WGS 84
st_crs(l3) # WGS 84
st_crs(l4) # WGS 84

st_crs(roads) # WGS 84
st_crs(houses) # WGS 84
st_crs(geom_texas) # NAD83 *** NEEDS TO MATCH THE OTHERS ** 
```

```{r}
# Create warning message function to check crs 
crs_check <- function(crs1, crs2) {
  if (st_crs(crs1) == st_crs(crs2)) {
    print("its a match")
  } else {
    print("Its NOT a match")
  }
}

# Check crs between roads, houses, and TX' geom
crs_check(roads, houses)
crs_check(roads, geom_texas)
crs_check(houses, geom_texas)

# Check crs between all the light dfs 
crs_check(l1, l2)
crs_check(li1, l3)
crs_check(l1, light_4)
crs_check(light_2, light_3)
crs_check(light_2, light_4)
crs_check(light_3, light_4)
```


### Transforming CRS

```{r}
# Convert SpatVector to sf 
sf_geom_texas <- st_as_sf(geom_texas)  

# Change geom_texas crs to match roads' crs with st_transform()
geom_texas <- st_transform(sf_geom_texas, st_crs(roads))
```

Final CRS Check

```{r}
# Check crs between roads, houses, and TX' geom
crs_check(roads, houses)
crs_check(roads, geom_texas)
crs_check(houses, geom_texas)
```


## Joining Texas Data

### Combine Geometry with the ACS
(American Community Survey data)

```{r}
# Combine the geometry (geom_texas) with the attributes (soc_texas) 
print(dim(geom_texas))
print(dim(soc_texas))

# Joining Texas's Socioeconomic df and geometries
texas_df <- cbind(geom_texas, soc_texas)
print(dim(texas_df))
```


## Create blackout mask

-   2021-02-07: l1 and l2

-   2021-02-16: l3 and l4

Create a raster object for each day
**Combine** light data by date - Feb 7 and 16 For stars() light data
```{r}


```


**Create Mask & Subset** for Blackout Regions that are greater than 200


**Crop** (spatially subset) the blackout mask to the Houston area


**Re-project** the cropped blackout dataset to EPSG:3083


**Plot**


Create **Before and After** plots - need to go back and do this !!!!
A set of maps comparing night light intensities before and after the first two storms



## Exclude highways from the cropped blackout mask

Identify areas within 200m of all highways


Areas that experienced blackouts that are further than 200m from a highway


## Homes impacted by blackouts

Homes that overlap with areas that experienced blackouts

Estimate of the number of homes in Houston that lost power

Mapping Homes that experienced blackouts

## Comparing Blackouts with Cenus Track data 

